<!DOCTYPE html>
<title>ECMAScript 5 parser</title>

<style>
body,html {margin:0;padding:0;background:#bbb}
fieldset {width:90%;border:0;padding:0;margin:0;position:relative;left:5%}
label {display:inline-block;border:2px solid black;width:90%;margin:1em 2%;position:relative;background:#AAA}
textarea {width:100%;height:24em;border:0}
h1,p,pre {width:80%;margin:1em auto}
h1 {margin-bottom:1.5em}
#status {height:8em;overflow:auto}
</style>

<!-- the parser itself -->
<script src=ES5Parser.js></script>

<!-- the showResult function to pretty-print the parse tree -->
<script src=PanPG_util.js></script>

<!-- for displaying the raw parse tree with JSON.stringify -->
<script src=../../compat/json2.js></script>

<script src=../../3box/util.js></script>

<h1>ECMAScript 5 Parser</h1>

<p>2010-08-16</p>

<p>Demonstrating an ECMAScript 5 parser generated by PanPG v0.0.6.

<p>The previous <a href=http://boshi.inimino.org/3box/asof/1269629763069/PEG/build/ES5.html>v5 codegen</a> (not to be confused with the v0.0.5 release, which used the v6 codegen; the codegen and PanPG version numbers are independent) was faster by about 5-10x on this grammar.
The reason for the slowdown is that the v6 codegen is currently completely unoptimized, unlike the v5 codegen which had some optimizations enabled.
The new codegen will eventually be much faster than the old.
See <a href=http://inimino.org/~inimino/blog/peg_roadmap>the project roadmap</a> for the details.
In short, v0.0.6 is an API release, and v0.0.7 and following will be performance releases.
</p>

<p>You can look at the <a href=../grammars/ECMAScript_5.peg>PEG input</a> from which the parser is generated.</p>

<p>Generating the ES5 parser from the PEG input takes around ten seconds of CPU time; here we read it from the server instead of generating it on each page load.
The <a href=demo.html>arithmetic demo</a> demonstrates generating a parser at runtime from a (much smaller) grammar.

<pre id=status></pre>

<fieldset>
<label>Input: <textarea id=text></textarea></label>
<label>Parse Tree pretty-printed by showTree(): <textarea id=parse_tree readonly></textarea></label>
<label>Parse Tree (raw) (see <a href=../doc/parse_tree_representation>documentation</a>): <textarea id=parse_tree_raw readonly></textarea></label>
</fieldset>

<script>

var inputText_el=document.getElementById('text')
  , parseTree_el=document.getElementById('parse_tree')
  , parseTreeRaw_el=document.getElementById('parse_tree_raw')
  , status_el=document.getElementById('status')
  , the_input

// report what we are doing and how long it takes:
function start(s){status_el.innerHTML+=s+'... ';ms=+new Date}
function finish(){status_el.innerHTML+=(+new Date-ms)+'ms\n';status_el.scrollTop=status_el.scrollHeight}

function xhr(method,uri,body,callback){var headers,p
 if(typeof method==='object'){headers=method.headers;method=method.method}
 var x=new XMLHttpRequest()
 x.onreadystatechange=function(){if (x.readyState==4){callback(x)}}
 x.open(method,uri,true)
 if(headers) for(p in headers){x.setRequestHeader(p,headers[p])}
 x.send(body)}

start('fetching input')
xhr('GET','Y.js',null,function(x){
 inputText_el.value=x.responseText
 finish()
 parseAndShow(inputText_el.value)})

function parseAndShow(s){var result,parser
 the_input=s
 start('parsing')
 result=ES5Parser.parse(s)
 finish()
 start('rendering parser output')
 parseTree_el.value=PanPG_util.showTree(result)
 finish()
 if(result[0]){
  start('displaying raw parse tree')
  parseTreeRaw_el.value=JSON.stringify(result[1].tree)
  finish()}}

function updateParseTree(){
 if(the_input==inputText_el.value)return
 parseAndShow(inputText_el.value)}

function delay(f,ms){return function(){
 if(f.pending) clearTimeout(f.pending)
 f.pending = setTimeout(f,ms)}}

inputText_el.onkeydown=inputText_el.onkeyup=inputText_el.onclick=delay(updateParseTree,250)
inputText_el.focus()

</script>